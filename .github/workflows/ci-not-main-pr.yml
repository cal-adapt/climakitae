# Workflow for pull_request events (non-main branches). Runs basic tests always; runs advanced when label is present.

name: ci-not-main-pr

on:
    pull_request:
        types: [synchronize, reopened, labeled, unlabeled]

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: psf/black@26.1.0

    test-basic:
        name: test (Python ${{ matrix.python-version }})
        runs-on: ubuntu-latest
        timeout-minutes: 30
        strategy:
            matrix:
                python-version: ["3.12", "3.13"]
            fail-fast: false
        defaults:
            run:
                shell: bash -l {0}
        steps:
            - name: Checkout project
              uses: actions/checkout@v4
            - name: Setup Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install uv
              run: |
                  python -m pip install --upgrade pip
                  pip install uv
            - name: Create uv virtual environment
              run: uv venv --python ${{ matrix.python-version }}
            - name: Install dependencies
              run: uv pip install -e ".[dev]"
            - name: Verify installation
              run: |
                  uv run python --version
                  uv run python -c "import climakitae; print(f'climakitae version: {climakitae.__version__}')"
            - name: Test with pytest (Basic)
              run: uv run python -m pytest --no-header -vv -m "not advanced"

    test-advanced:
        name: test-advanced (Python ${{ matrix.python-version }})
        runs-on: ubuntu-latest
        timeout-minutes: 30
        if: contains(github.event.pull_request.labels.*.name, 'Advanced Testing')
        strategy:
            matrix:
                python-version: ["3.12", "3.13"]
            fail-fast: false
        defaults:
            run:
                shell: bash -l {0}
        steps:
            - name: Checkout project
              uses: actions/checkout@v4
            - name: Setup Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install uv
              run: |
                  python -m pip install --upgrade pip
                  pip install uv
            - name: Create uv virtual environment
              run: uv venv --python ${{ matrix.python-version }}
            - name: Install dependencies
              run: uv pip install -e ".[dev]"
            - name: Verify installation
              run: |
                  uv run python --version
                  uv run python -c "import climakitae; print(f'climakitae version: {climakitae.__version__}')"
            - name: Test with pytest (Advanced)
              run: uv run python -m pytest --no-header -vv -m "advanced"
